import React, { useEffect, useRef, useState } from 'react';

// A-Frame is loaded via a script tag in the HTML, so we don't import it directly here.
// We expect 'AFRAME' to be globally available after the script loads.

function App() {
  const videoRef = useRef(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [showOverlay, setShowOverlay] = useState(true);

  // Example 360 video URL. Replace this with your actual YouTube/Vimeo 360 video URL.
  // Note: For YouTube/Vimeo, you usually need to get the direct video file URL or
  // use their iframe embed, which might not work directly with A-Frame's <a-video> component.
  // For A-Frame, it's best to use a direct MP4 URL that is 360-formatted (equirectangular).
  // I'm using a placeholder and providing instructions.
  const videoSource = "https://www.learningcontainer.com/wp-content/uploads/2020/05/sample-mp4-file.mp4"; // Placeholder - REPLACE WITH YOUR 360 VIDEO URL

  useEffect(() => {
    // Dynamically load A-Frame script
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js';
    script.async = true;
    script.onload = () => {
      console.log('A-Frame script loaded.');
      // A-Frame components are registered globally, so we can now safely use them
      // Ensure the scene is ready
      const scene = document.querySelector('a-scene');
      if (scene) {
        scene.addEventListener('loaded', () => {
          console.log('A-Frame scene loaded.');
        });
      }
    };
    document.head.appendChild(script);

    return () => {
      document.head.removeChild(script);
    };
  }, []);

  const handleStartExperience = () => {
    if (videoRef.current) {
      // Attempt to play the video. Browsers might still block if not muted or user hasn't interacted enough.
      // Setting muted to true for better autoplay chances.
      videoRef.current.play().then(() => {
        setIsPlaying(true);
        setShowOverlay(false);
      }).catch(error => {
        console.error("Autoplay failed:", error);
        // If autoplay fails, the user might need to click again or unmute.
        // Provide a message to the user.
        alert("Video autoplay blocked by browser. Please unmute or try again.");
      });
    }
  };

  return (
    <div className="relative w-full h-screen flex flex-col items-center justify-center bg-gray-900 overflow-hidden">
      <div className="absolute inset-0 z-0">
        {/* A-Frame scene for the 360 video */}
        <a-scene embedded vr-mode-ui="enabled: false">
          {/* Asset management: Preload the video */}
          <a-assets>
            <video
              id="video360"
              ref={videoRef}
              crossOrigin="anonymous"
              src={videoSource}
              loop={true}
              muted={true} // Start muted for better autoplay chances
              playsInline={true} // Important for iOS
              preload="auto"
            ></video>
          </a-assets>

          {/* 360 Video Sphere */}
          <a-videosphere src="#video360" rotation="0 180 0"></a-videosphere>

          {/* Camera with look-controls for device orientation and mouse drag */}
          {/* `look-controls` enables looking around with mouse drag on desktop and device motion on mobile */}
          <a-entity camera look-controls="pointerLockEnabled: false"></a-entity>

          {/* Optional: Add a simple sky for background if video isn't loaded */}
          <a-sky color="#000"></a-sky>
        </a-scene>
      </div>

      {/* Overlay for start button and instructions */}
      {showOverlay && (
        <div className="absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-10 p-4">
          <div className="bg-white rounded-xl p-8 shadow-2xl text-center max-w-lg mx-auto">
            <h1 className="text-3xl font-bold text-gray-800 mb-4">Immersive VR Experience</h1>
            <p className="text-gray-700 text-lg mb-6">
              Welcome to your immersive journey!
              <br />
              Please click the button below to start the 360-degree video.
              <br />
              <strong className="text-red-600">Important: Replace the placeholder video URL with your own 360 video URL for the full experience!</strong>
              <br />
              (Make sure your video is in equirectangular format for 360 playback).
            </p>
            <button
              onClick={handleStartExperience}
              className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
            >
              Start Experience
            </button>
            <p className="text-sm text-gray-500 mt-4">
              Once started, move your phone around or drag your mouse to look around in the video.
            </p>
          </div>
        </div>
      )}

      {/* Control button for unmuting/muting if needed after start */}
      {isPlaying && (
        <div className="absolute bottom-4 right-4 z-20">
          <button
            onClick={() => {
              if (videoRef.current) {
                videoRef.current.muted = !videoRef.current.muted;
              }
            }}
            className="bg-gray-800 hover:bg-gray-700 text-white py-2 px-4 rounded-full text-sm opacity-80"
          >
            {videoRef.current?.muted ? 'Unmute' : 'Mute'}
          </button>
        </div>
      )}
    </div>
  );
}

export default App;
